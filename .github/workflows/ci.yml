name: build

on:
    push:
      branches:
        - main
    pull_request:
      branches:
        - main
jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y linux-tools-common libelf-dev linux-libc-dev clang libbpf-dev make pkg-config jq
      - uses: actions/checkout@v2
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"
      - name: Download pre-built DuckDB library
        run: |
          wget -q https://github.com/duckdb/duckdb/releases/download/v1.4.2/libduckdb-linux-amd64.zip -O /tmp/libduckdb.zip
          unzip /tmp/libduckdb.zip -d ${{ github.workspace }}/libduckdb
      - name: Run Tests
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
          DUCKDB_LIB_DIR: "${{ github.workspace }}/libduckdb"
          DUCKDB_INCLUDE_DIR: "${{ github.workspace }}/libduckdb"
          LD_LIBRARY_PATH: "${{ github.workspace }}/libduckdb"
        run: cargo test --no-default-features

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y linux-tools-common libelf-dev linux-libc-dev clang libbpf-dev make pkg-config jq
      - uses: actions/checkout@v2
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: "true"
      - name: Download pre-built DuckDB library
        run: |
          wget -q https://github.com/duckdb/duckdb/releases/download/v1.4.2/libduckdb-linux-amd64.zip -O /tmp/libduckdb.zip
          unzip /tmp/libduckdb.zip -d ${{ github.workspace }}/libduckdb
      - name: Run Clippy
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
          DUCKDB_LIB_DIR: "${{ github.workspace }}/libduckdb"
          DUCKDB_INCLUDE_DIR: "${{ github.workspace }}/libduckdb"
          LD_LIBRARY_PATH: "${{ github.workspace }}/libduckdb"
        run: cargo clippy --no-default-features -- -D warnings
